{% extends 'core/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  <h1>Welcome, {{ user.username }}</h1>

  <div class="list-group">
    <a href="{% url 'core:low_stock' %}" class="list-group-item list-group-item-warning">
      Low Stock ({{ low_stock_count }})
    </a>
    <a href="{% url 'core:forecast_report' %}" class="list-group-item list-group-item-info">
      Outdated Forecasts ({{ outdated_forecasts }})
    </a>
    <a href="{% url 'core:product_list' %}" class="list-group-item">All Products</a>
    <a href="{% url 'core:order_list' %}" class="list-group-item">All Orders</a>
    <a href="{% url 'core:order_create' %}" class="list-group-item list-group-item-success">
      Create New Order
    </a>
  </div>
  <div class="row mb-4">
    <!-- Period Buttons -->
    {% for p,label in [('today','Today'),('week','This Week'),('month','This Month')] %}
    <a href="?period={{p}}" class="btn btn-outline-primary {% if selected_period==p %}active{% endif %}">
      {{ label }}
    </a>
    {% endfor %}
  </div>
  
  <div class="row g-4">
    <!-- Total Products -->
    <div class="col-md-3">
      <div class="card text-white bg-secondary">
        <div class="card-body">
          <h5>Total Products</h5>
          <h2>{{ total_products }}</h2>
        </div>
      </div>
    </div>
    <!-- Active Retailers -->
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5>Active Retailers</h5>
          <h2>{{ active_retailers }}</h2>
        </div>
      </div>
    </div>
    <!-- 30-Day Sales -->
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5>30-Day Sales (KSh)</h5>
          <h2>{{ sales_30d|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
    <!-- Inventory Value -->
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5>Inventory Value (KSh)</h5>
          <h2>{{ inventory_value|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4">
    <!-- Sales Trend Chart -->
    <div class="col-md-8">
      <canvas id="salesTrendChart"></canvas>
    </div>
    <!-- Quick Actions -->
    <div class="col-md-4">
      {% for action in quick_actions %}
      <a href="{% url action.url %}" class="btn btn-outline-dark w-100 mb-2">
        <i class="bi {{ action.icon }}"></i> {{ action.label }}
      </a>
      {% endfor %}
    </div>
  </div>
  
  <div class="row mt-5">
    <!-- Recent Orders -->
    <div class="col-md-6">
      <h4>Recent Orders <a href="{% url 'core:order_list' %}" class="small">view all</a></h4>
      <ul class="list-group">
        {% for o in recent_orders %}
        <li class="list-group-item">
          #{{ o.reference }} — {{ o.order_date|date:"M d" }}
        </li>
        {% empty %}
        <li class="list-group-item">No recent orders.</li>
        {% endfor %}
      </ul>
    </div>
    <!-- Top Products -->
    <div class="col-md-6">
      <h4>Top Selling Products <a href="{% url 'core:sales_report' %}" class="small">view reports</a></h4>
      <ul class="list-group">
        {% for p in top_products %}
        <li class="list-group-item">
          {{ p.product__name }} — {{ p.total_qty }}
        </li>
        {% empty %}
        <li class="list-group-item">No sales data.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    new Chart(document.getElementById('salesTrendChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: {{ sales_trend_labels|safe }},
        datasets: [{
          label: 'Revenue (KSh)',
          data: {{ sales_trend_data|safe }},
          fill: true,
        }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  </script>
  
{% endblock %}
